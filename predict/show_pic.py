# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'show_pic.ui'
#
# Created by: PyQt5 UI code generator 5.11.3
#
# WARNING! All changes made in this file will be lost!

from PyQt5 import QtCore, QtGui, QtWidgets
import shutil
import sqrt_deal_pic as sp
import cv2
import predict as pd
import B2M as bm
class Ui_MainWindow(object):
    def setupUi(self, MainWindow):
        MainWindow.setObjectName("MainWindow")
        MainWindow.resize(800, 600)
        self.centralwidget = QtWidgets.QWidget(MainWindow)
        self.centralwidget.setObjectName("centralwidget")
        self.graphicsView = QtWidgets.QGraphicsView(self.centralwidget)
        self.graphicsView.setGeometry(QtCore.QRect(120, 80, 260, 200))
        self.graphicsView.setObjectName("graphicsView")
        self.graphicsView_2 = QtWidgets.QGraphicsView(self.centralwidget)
        self.graphicsView_2.setGeometry(QtCore.QRect(400, 80, 260, 200))
        self.graphicsView_2.setObjectName("graphicsView_2")
        self.graphicsView_3 = QtWidgets.QGraphicsView(self.centralwidget)
        self.graphicsView_3.setGeometry(QtCore.QRect(120, 300, 260, 200))
        self.graphicsView_3.setObjectName("graphicsView_3")
        self.graphicsView_4 = QtWidgets.QGraphicsView(self.centralwidget)
        self.graphicsView_4.setGeometry(QtCore.QRect(400, 300, 260, 200))
        self.graphicsView_4.setObjectName("graphicsView_4")
        self.label = QtWidgets.QLabel(self.centralwidget)
        self.label.setGeometry(QtCore.QRect(120, 20, 160, 41))
        font = QtGui.QFont()
        font.setPointSize(15)
        self.label.setFont(font)
        self.label.setObjectName("label")
        self.label_2 = QtWidgets.QLabel(self.centralwidget)
        self.label_2.setGeometry(QtCore.QRect(430, 20, 201, 41))
        font = QtGui.QFont()
        font.setPointSize(15)
        self.label_2.setFont(font)
        self.label_2.setObjectName("label_2")
        self.label_3 = QtWidgets.QLabel(self.centralwidget)
        self.label_3.setGeometry(QtCore.QRect(150, 510, 201, 41))
        font = QtGui.QFont()
        font.setPointSize(15)
        self.label_3.setFont(font)
        self.label_3.setObjectName("label_3")
        self.label_4 = QtWidgets.QLabel(self.centralwidget)
        self.label_4.setGeometry(QtCore.QRect(430, 510, 201, 41))
        font = QtGui.QFont()
        font.setPointSize(15)
        self.label_4.setFont(font)
        self.label_4.setObjectName("label_4")
        self.toolButton = QtWidgets.QToolButton(self.centralwidget)
        self.toolButton.setGeometry(QtCore.QRect(270, 32, 40, 20))
        self.toolButton.setObjectName("toolButton")
        MainWindow.setCentralWidget(self.centralwidget)
        self.menubar = QtWidgets.QMenuBar(MainWindow)
        self.menubar.setGeometry(QtCore.QRect(0, 0, 800, 23))
        self.menubar.setObjectName("menubar")
        self.menu = QtWidgets.QMenu(self.menubar)
        self.menu.setObjectName("menu")
        self.menu_2 = QtWidgets.QMenu(self.menu)
        self.menu_2.setObjectName("menu_2")
        self.menu_3 = QtWidgets.QMenu(self.menubar)
        self.menu_3.setObjectName("menu_3")
        MainWindow.setMenuBar(self.menubar)
        self.statusbar = QtWidgets.QStatusBar(MainWindow)
        self.statusbar.setObjectName("statusbar")
        MainWindow.setStatusBar(self.statusbar)
        self.action_2 = QtWidgets.QAction(MainWindow)
        self.action_2.setObjectName("action_2")
        self.action_3 = QtWidgets.QAction(MainWindow)
        self.action_3.setObjectName("action_3")
        self.action = QtWidgets.QAction(MainWindow)
        self.action.setObjectName("action")
        self.menu_2.addAction(self.action_2)
        self.menu.addAction(self.menu_2.menuAction())
        self.menu.addAction(self.action_3)
        self.menu_3.addAction(self.action)
        self.menubar.addAction(self.menu_3.menuAction())
        self.menubar.addAction(self.menu.menuAction())

        self.toolButton.clicked.connect(self.show_pre)

        self.retranslateUi(MainWindow)
        QtCore.QMetaObject.connectSlotsByName(MainWindow)

    def show_pre(self):
        fname = QtWidgets.QFileDialog.getOpenFileName(self.centralwidget, 'Open file', './example', "All Files (*);;Byte Files (*.bytes);;Exe Files(*.exe)")
        self.pic_filename = None
        if fname[0].split('/')[-1].split('.')[-1] == 'bytes':
            self.byte_filename = fname[0].split('/')[-1]
            shutil.copyfile(fname[0], './test_file/bytes/' + self.byte_filename)
            self.pic_filename = sp.change_to_pic('./test_file/bytes', self.byte_filename, './test_file/pic')
        elif fname[0].split('/')[-1].split('.')[-1] == 'exe':
            self.byte_filename = fname[0].split('/')[-1]
            shutil.copyfile(fname[0], './test_file/exe/' + self.byte_filename)
            self.pic_filename = bm.exe_to_pic('./test_file/exe', self.byte_filename, './test_file/pic')
        elif fname[0]:
            QtWidgets.QMessageBox.information(self.centralwidget, "警告", "只能上传以bytes或者exe结尾的文件",
                                              QtWidgets.QMessageBox.Yes)
        if self.pic_filename:
            todir = './test_file/pic'
            img_path = todir + '/' + self.pic_filename
            image = cv2.imread(img_path, cv2.IMREAD_GRAYSCALE)
            image = cv2.resize(image, (250, 195))

            frame = QtGui.QImage(image, 250, 195, QtGui.QImage.Format_Indexed8)
            pix = QtGui.QPixmap.fromImage(frame)
            self.item = QtWidgets.QGraphicsPixmapItem(pix)  # 创建像素图元
            self.scene = QtWidgets.QGraphicsScene()  # 创建场景
            self.scene.addItem(self.item)
            self.graphicsView.setScene(self.scene)  # 将场景添加至视图

            pic_dir = './test_file/pic'
            wdir = './test_file/deal_pic'

            #predict = int(pd.read_model(pic_dir, self.pic_filename, wdir)) + 1

            score, predict = pd.read_model(pic_dir, self.pic_filename, wdir)
            predict = int(predict) + 1
            print(score)
            if score > 12:
                print('true')
                similar_dilr = './image/' + str(predict) + '/' + '1.jpg'
                image = cv2.imread(similar_dilr, cv2.IMREAD_GRAYSCALE)
                image = cv2.resize(image, (250, 195))

                frame = QtGui.QImage(image, 250, 195, QtGui.QImage.Format_Indexed8)
                pix = QtGui.QPixmap.fromImage(frame)
                self.item_2 = QtWidgets.QGraphicsPixmapItem(pix)  # 创建像素图元
                self.scene_2 = QtWidgets.QGraphicsScene()  # 创建场景
                self.scene_2.addItem(self.item_2)
                self.graphicsView_2.setScene(self.scene_2)  # 将场景添加至视图

                if predict == 9:
                    fd = 1
                else:
                    fd = predict + 1

                diffient_dilr_1 = './image/' + str(fd) + '/' + '1.jpg'
                image = cv2.imread(diffient_dilr_1, cv2.IMREAD_GRAYSCALE)
                image = cv2.resize(image, (250, 195))

                frame = QtGui.QImage(image, 250, 195, QtGui.QImage.Format_Indexed8)
                pix = QtGui.QPixmap.fromImage(frame)
                self.item_3 = QtWidgets.QGraphicsPixmapItem(pix)  # 创建像素图元
                self.scene_3 = QtWidgets.QGraphicsScene()  # 创建场景
                self.scene_3.addItem(self.item_3)
                self.graphicsView_3.setScene(self.scene_3)  # 将场景添加至视图

                if predict == 1:
                    fd = 9
                else:
                    fd = predict - 1

                diffient_dilr_2 = './image/' + str(fd) + '/' + '1.jpg'
                image = cv2.imread(diffient_dilr_2, cv2.IMREAD_GRAYSCALE)
                image = cv2.resize(image, (250, 195))

                frame = QtGui.QImage(image, 250, 195, QtGui.QImage.Format_Indexed8)
                pix = QtGui.QPixmap.fromImage(frame)
                self.item_4 = QtWidgets.QGraphicsPixmapItem(pix)  # 创建像素图元
                self.scene_4 = QtWidgets.QGraphicsScene()  # 创建场景
                self.scene_4.addItem(self.item_4)
                self.graphicsView_4.setScene(self.scene_4)  # 将场景添加至视图
            else:
                self.graphicsView_2.setScene(None)
                self.graphicsView_3.setScene(None)
                self.graphicsView_4.setScene(None)
                QtWidgets.QMessageBox.information(self.centralwidget, "警告", "该文件不属于恶意代码样本",
                                                  QtWidgets.QMessageBox.Yes)




    def retranslateUi(self, MainWindow):
        _translate = QtCore.QCoreApplication.translate
        MainWindow.setWindowTitle(_translate("MainWindow", "恶意代码家族标注系统"))
        self.label.setText(_translate("MainWindow", "请上传您的样本"))
        self.label_2.setText(_translate("MainWindow", "样本库中的同族图像"))
        self.label_3.setText(_translate("MainWindow", "样本库中的不同族图像A"))
        self.label_4.setText(_translate("MainWindow", "样本库中的不同族图像B"))
        self.toolButton.setText(_translate("MainWindow", "上传"))
        self.menu.setTitle(_translate("MainWindow", "查看"))
        self.menu_2.setTitle(_translate("MainWindow", "可视化"))
        self.menu_3.setTitle(_translate("MainWindow", "主功能"))
        self.action_2.setText(_translate("MainWindow", "恶意代码图像"))
        self.action_3.setText(_translate("MainWindow", "恶意代码家族介绍"))
        self.action.setText(_translate("MainWindow", "预测家族属性"))

