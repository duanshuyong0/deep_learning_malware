import os
import numpy as np
from PIL import Image
import math

def isSqr(n):
    a = int(math.sqrt(n))
    if a*a == n:
        return True
    else:
        return False

def change_to_pic(filedir, fname, todir):
    filename = os.path.join(filedir, fname)
    if not os.path.exists(filename):
        return "该文件不存在"
    if fname.endswith(".bytes") == False:
        return "上传恶意代码文件无效"
    with open(filename, 'r') as file:
        content = []
        for line in file:
            line = line[line.find(" ") + 1:]  # 把行标处理掉
            line = line.strip('\n')  # 去除换行符
            list = line.split(' ')  # 转为列表
            while len(list) < 16:
                list.append('0')
            if '??' not in list and line.count("00") < 16:
                content.append(list)
        if len(content) == 0:
            return "该文件为无效文件"
        for i in range(len(content)):
            for j in range(len(content[i])):
                content[i][j] = int(content[i][j], 16)
        a = np.array(content)
        #print(a.shape)
        sp = a.shape[0] * a.shape[1]
        while not isSqr(sp):
            a = np.vstack((a, np.zeros(a.shape[1])))
            sp = a.shape[0] * a.shape[1]
        leng = int(math.sqrt(sp))
        a = np.reshape(a, [leng, leng])
        a = a.astype('uint8')
        im = Image.fromarray(a)
        s = todir + '\\' + fname.split('.')[0] + '.jpg'
        im.save(s)
        return fname.split('.')[0] + '.jpg'

# if __name__ == '__main__':
#     parser = argparse.ArgumentParser(description='change to pic')
#     filedir = r'C:\Users\49627\Desktop\two_eight\test_file\bytes'
#     todir = r'C:\Users\49627\Desktop\two_eight\test_file\pic'
#     parser.add_argument('--filedir', type=str, default=filedir)
#     parser.add_argument('--todir', type=str, default=todir)
#     parser.add_argument('--fname', type=str, default='iwXK2bUysO0CPvBf8nTt.bytes')
#     args = parser.parse_args()
#     s = change_to_pic(args.filedir, args.fname, args.todir)
#     print(s)